name: Build Metrolist GMS RELEASE APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Unzip Source Code
        run: |
          ZIP_FILE=$(ls *.zip | head -n 1)
          unzip "$ZIP_FILE"
          SUBFOLDER=$(ls -d */ | grep "Metrolist" | head -n 1)
          if [ -n "$SUBFOLDER" ]; then
            mv "$SUBFOLDER"* .
            mv "$SUBFOLDER".* . 2>/dev/null || true
          fi

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Create Temporary Keystore
        run: |
          keytool -genkey -v -keystore temp.jks -keyalg RSA -keysize 2048 -validity 10000 \
            -alias my-key-alias -storepass my-password -keypass my-password \
            -dname "CN=Metrolist, OU=Dev, O=Metrolist, L=Unknown, S=Unknown, C=US"

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Build GMS Release APK
        run: |
          ./gradlew assembleUniversalGmsRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/temp.jks \
            -Pandroid.injected.signing.store.password=my-password \
            -Pandroid.injected.signing.key.alias=my-key-alias \
            -Pandroid.injected.signing.key.password=my-password

      - name: Upload GMS Release APK
        uses: actions/upload-artifact@v4
        with:
          name: Metrolist-Enhanced-GMS-RELEASE-APK
          path: app/build/outputs/apk/universalGms/release/*.apk
