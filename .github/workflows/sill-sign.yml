name: Build Metrolist Universal Release APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Unzip Metrolist project
      run: |
        ZIP_FILE=$(ls *.zip | head -n 1)
        if [ -z "$ZIP_FILE" ]; then
          echo "No zip file found. Exiting."
          exit 1
        fi
        echo "Found zip file: $ZIP_FILE"
        mkdir temp_extract
        unzip "$ZIP_FILE" -d temp_extract
        
        # Find the actual source directory inside temp_extract
        SOURCE_DIR=$(find temp_extract -maxdepth 1 -mindepth 1 -type d -print -quit)
        if [ -n "$SOURCE_DIR" ]; then
          echo "Source directory found: $SOURCE_DIR"
          # Move all contents except .github to the root
          shopt -s extglob # Enable extended globbing for !(pattern)
          mv "$SOURCE_DIR"/!(.github) . || true
          mv "$SOURCE_DIR"/.[!.]* . || true # Move hidden files (excluding . and ..)
          shopt -u extglob # Disable extended globbing
        else
          echo "No single source directory found, moving all contents from temp_extract (excluding .github)."
          shopt -s extglob # Enable extended globbing for !(pattern)
          mv temp_extract/!(.github) . || true
          mv temp_extract/.[!.]* . || true # Move hidden files (excluding . and ..)
          shopt -u extglob # Disable extended globbing
        fi
        rm -rf temp_extract
        echo "Unzipping complete. Current directory contents:"
        ls -aR

    - name: Set up Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        # cache: gradle # Removed or commented out to avoid issues if build.gradle is not immediately available

    - name: Create Temporary Keystore
      run: |
        keytool -genkey -v -keystore temp.jks -keyalg RSA -keysize 2048 -validity 10000 \
        -alias my-key-alias -storepass my-password -keypass my-password \
        -dname "CN=Metrolist, OU=Dev, O=Metrolist, L=Unknown, S=Unknown, C=US"

    - name: Grant execute permission
      run: chmod +x gradlew

    - name: Build UNIVERSAL GMS RELEASE
      run: ./gradlew assembleUniversalGmsRelease --no-daemon \
        -Pandroid.injected.signing.store.file=$(pwd)/temp.jks \
        -Pandroid.injected.signing.store.password=my-password \
        -Pandroid.injected.signing.key.alias=my-key-alias \
        -Pandroid.injected.signing.key.password=my-password

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Metrolist-Universal-GMS-Release
        path: app/build/outputs/apk/universalGms/release/*.apk
